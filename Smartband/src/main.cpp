#include <Arduino.h>

//BLE through NimBLE framework
#include <NimBLEDevice.h>
#include <NimBLEUtils.h>
#include <NimBLEServer.h>

//Time, note: send bytes in Little Endian
#include <time.h>

// UUIDs for BLE Service and Characteristics
#define SERVICE_UUID        "12345678-1234-1234-1234-123456789113"
#define MESSAGE_TRANSFER_UUID "e2e3f5a4-8c4f-11eb-8dcd-0242ac130005"
#define CONFIRMATION_UUID "e2e3f5a4-8c4f-11eb-8dcd-0242ac130006"  // confirmation from app regarding file transmission success
#define TIME_SYNC_UUID "e2e3f5a4-8c4f-11eb-8dcd-0242ac130007"

//BLUE LED
#define LED_PIN_BLE 2

NimBLEServer* pServer = nullptr;
NimBLEService* pService = nullptr; 
NimBLEAdvertising* pAdvertising = nullptr; 
NimBLECharacteristic* pMessageTransferCharacteristic = nullptr;
NimBLECharacteristic* pConfirmationCharacteristic = nullptr;
NimBLECharacteristic* pTimeSyncCharacteristic = nullptr;

NimBLECharacteristicCallbacks* fileTransferCallbacks = nullptr;
NimBLECharacteristicCallbacks* confirmationCallbacks = nullptr;
NimBLECharacteristicCallbacks* timeSyncCallbacks = nullptr;
bool deviceConnected = false;

//For time counter in UTC format
unsigned long syncedTime = 0; // time synchronized using app's time (UNIX timestamp)
unsigned long lastSyncMillis = 0; // time in milliseconds when synchronization occurred
unsigned long time1; //for displaying time in loop()

class ServerCallbacks: public NimBLEServerCallbacks {
    void onConnect(NimBLEServer* pServer) override {
        deviceConnected = true;
        Serial.println("Client connected.");
    };

    void onDisconnect(NimBLEServer* pServer) override {
        deviceConnected = false;
        Serial.println("Client disconnected.");
    }
};

class MessageTransferCallbacks : public NimBLECharacteristicCallbacks {
private:
    String message = "Training start time (UTC): 1970-01-01 01:00:00\n3600\nIR,RED,Ax,Ay,Az\n6213,8447,1212,1404,16320\n8623,13290,1432,1384,16096\n11467,19230,1516,1248,16144\n14751,26472,1148,1256,16012\n18845,36170,956,1512,16276\n24059,48666,812,1428,16360\n30245,63505,920,1332,16508\n36968,79137,964,1412,16408\n43246,93696,952,1332,16276\n48949,108681,1056,1300,16052\n54289,123951,1192,1348,16148\n59101,137182,988,1404,16292\n62486,147352,820,1316,16464\n65579,155525,872,1372,16252\n67712,160586,1052,1424,16304\n69141,163993,1104,1344,16184\n69965,165873,1048,1436,16356\n70056,165437,788,1472,16484\n68354,160624,788,1352,16344\n63723,148544,1072,1328,16192\n57054,133495,1096,1336,16208\n51498,123223,1012,1320,16092\n48765,119111,1392,1304,16052\n48788,121747,1408,1328,15996\n52521,136009,1220,1416,16368\n61381,156174,1004,1456,16132\n72947,159878,1116,1344,15900\n82711,172704,1676,1112,16888\n85739,176456,636,1492,15776\n90185,181719,-356,1576,16676\n96184,185054,1300,1224,16100\n98153,186204,1324,1428,16172\n99199,186981,980,1412,16368\n100112,187606,732,1296,16228\n100827,188121,588,1272,16224\n101378,188575,600,1416,16520\n101849,188938,380,1444,16388\n102201,189158,684,1464,16356\n102473,189322,1028,1364,16100\n102738,189470,1180,1308,16180\n102940,189531,780,1332,16424\n103085,189539,856,1368,16296\n103212,189571,1240,1240,16268\n103298,189551,1112,1288,16176\n103381,189565,1048,1460,16232\n103459,189583,1064,1328,16300\n103557,189662,1032,1292,16200\n103643,189704,980,1360,16352\n103716,189715,1120,1268,16268\n103790,189759,1128,1332,16264\n103852,189827,1032,1356,16296\n103903,189857,1180,1304,16236\n103962,189913,1324,1328,16300\n104029,189951,1148,1360,16168\n104070,189973,1060,1392,16220\n104130,190011,976,1444,16360\n104137,190033,836,1408,16364\n104156,190059,820,1420,16424\n104186,190065,832,1424,16220\n104230,190081,944,1360,16256\n104266,190096,1044,1188,16268\n104290,190127,996,1372,16464\n104320,190141,888,1332,16464\n104363,190157,1064,1216,16208\n104391,190160,1100,1348,16176\n104392,190152,1100,1304,16376\n104425,190162,1080,1320,16276\n104426,190166,1052,1364,16160\n104425,190143,908,1288,16432\n104410,190113,952,1300,16400\n104399,190105,932,1316,16232\n104400,190081,1004,1444,16304\n104384,190064,1016,1332,16212\n104383,190049,884,1412,16192\n104381,190036,912,1412,16356\n104388,190023,940,1300,16332\n104405,190030,1040,1428,16284\n104425,190057,908,1384,16356\n104470,190074,868,1336,16416\n104508,190084,988,1344,16320\n104558,190097,892,1396,16208\n104624,190143,848,1404,16324\n104695,190179,592,1492,16304\n104814,190235,764,1424,16400\n104930,190307,1088,1356,16440\n105088,190389,1828,1104,16280\n105252,190463,2448,980,15992\n105395,190551,2148,976,15912\n105541,190660,1236,1348,16536\n105681,190749,1348,1308,16404\n105834,190917,1440,1260,16384\n105906,190904,1424,1180,16228\n106053,191043,1584,1244,16472\n106119,191066,1812,1152,16064\n106282,191218,1976,1192,16172\n106366,191219,2372,1028,15804\n106481,191300,2816,1008,15676\n106518,191323,2468,1016,15772\n106586,191351,2332,980,15924\n106613,191334,2428,988,15820\n106607,191290,2108,1196,16132\n106598,191284,1784,1236,16240\n106554,191229,1660,1108,16352\n106558,191204,1768,1136,16208\n106484,191154,1632,1200,16228\n106482,191136,1660,1312,16152\n106410,191058,1404,1212,16404\n106378,191032,1388,1240,16268\n106268,190951,1228,1332,16352\n106224,190901,1140,1404,16280\n106162,190876,1140,1372,16412\n106125,190841,1272,1316,16216\n106078,190810,1020,1288,16244\n106077,190794,808,1400,16440\n106057,190777,1088,1360,16460\n106065,190818,1052,1328,16312\n106074,190798,1048,1276,16256\n106097,190842,1032,1396,16260\n106113,190802,1044,1360,16416\n106188,190882,1016,1320,16348\n106210,190908,1200,1312,16208\n106332,191026,1296,1312,16612\n106356,191035,1376,1428,16336\n106502,191184,1088,1356,16480\n106579,191227,1472,1336,16576\n106737,191401,1800,1188,16500\n106834,191525,2280,1132,16168\n106988,191659,2296,1012,15900\n107082,191804,2448,1036,16172\n107224,191908,2376,1024,16068\n107346,192115,2080,1204,16464\n107456,192208,2372,1056,16052\n107610,192402,2968,904,15980\n107783,192608,2888,988,15940\n107818,192610,3032,960,15948\n107849,192616,2872,916,15756\n107805,192554,2812,956,15904\n107802,192471,2748,1000,15860\n107738,192363,2692,1008,15828\n107673,192278,2600,1048,15792\n107589,192137,2016,1304,16512\n107522,192048,1556,1132,16336\n107436,191905,1708,1204,16432\n107328,191802,1452,1336,16444\n107215,191694,1292,1276,16360\n107131,191665,972,1368,16548\n107055,191587,820,1352,16548\n107026,191632,688,1432,16344\n106954,191655,508,1320,16360\n106952,191795,1152,1400,16560\n106909,191823,2208,952,16384\n106927,191946,1388,1192,16208\n106885,191904,136,1612,16140\n106926,191966,-800,1568,16172\n106895,191978,-1684,1828,16316\n106919,191987,-1148,1684,16432\n106907,191957,256,1396,16472\n106902,191884,500,1380,16480\n106883,191781,800,1408,16628\n106833,191654,1024,1404,16464\n106896,191634,1516,1096,16136\n106889,191572,1580,1192,16304\n106940,191594,1696,1192,16196\n106953,191567,1644,1208,16280\n107013,191582,1756,1224,16264\n107026,191592,1968,1156,16184\n107093,191615,2156,1084,16208\n107077,191606,2876,900,15356\n107114,191622,2984,968,15608\n107095,191586,2632,1044,15928\n107087,191552,2264,1084,16068\n107042,191495,1924,1164,16216\n107018,191510,1200,1296,16436\n106977,191531,1276,1312,16488\n106987,191636,760,1396,16496\n106986,191738,596,1444,16584\n107057,191943,440,1428,16656\n107088,192063,2140,1240,16268\n107136,192214,1304,1448,16388\n107082,192162,-524,1476,16112\n107147,192258,-820,1592,16380\n107103,192193,-1200,1572,16288\n107166,192249,-264,1464,16548\n107124,192172,332,1408,16400\n107147,192131,716,1384,16552\n107066,192034,860,1412,16268\n107076,191939,904,1304,16508\n107072,191884,1236,1412,16308\n107076,191810,1512,1224,16088\n107151,191831,1588,1232,16404\n107161,191791,1664,1272,16476\n107248,191838,1800,1256,16232\n107273,191839,1860,1144,16260\n107363,191891,2180,1060,16116\n107401,191894,2496,1004,15804\n107450,191939,2660,992,15840\n107484,191950,2904,956,15664\n107522,191946,2904,812,15728\n107528,191940,2764,916,15780\n107516,191912,2648,896,15884\n107507,191891,2348,1100,15860\n107472,191915,1560,1388,16692\n107464,191900,1916,1024,16300\n107445,191932,864,1152,16360\n107443,191914,1124,1260,16328\n107427,191976,1284,1380,16236\n107358,191963,896,1484,16428\n107383,192036,896,1408,16400\n107326,192034,800,1396,16240\n107383,192120,584,1440,16428\n107312,192072,596,1508,16448\n107352,192165,548,1468,16208\n107310,192102,456,1472,16340\n107300,192152,232,1472,16516\n107244,192109,628,1316,16276\n107239,192075,84,1504,16524\n107237,192055,652,1484,16268\n107210,191989,840,1516,16376\n107248,191997,700,1480,16488\n107238,191942,812,1492,16508\n107321,191961,1000,1304,16684\n107354,191989,1084,1396,16628\n107465,192002,1300,1368,16620\n107506,192012,1600,1212,16336\n107613,192084,2048,1096,16448\n107686,192128,2252,1200,16308\n107813,192180,2916,912,15924\n107849,192259,3356,728,15772\n107918,192321,3976,652,15636\n107983,192356,4140,720,15396\n107997,192346,4236,448,15452\n107995,192323,4096,608,15324\n107985,192296,3848,596,15628\n107968,192205,3836,776,15424\n107943,192190,3880,660,15368\n107879,192051,3500,796,15484\n107849,192004,3928,828,15568\n107765,191931,3968,736,15268\n107845,192071,2800,820,15916\n107837,192093,1968,1152,16344\n107955,192283,1888,1364,16664\n107987,192356,1204,1964,17468\n108093,192483,3056,872,16760\n108030,192472,3968,2160,16592\n107955,192440,3292,1736,16444\n107822,192371,400,380,16024\n107752,192343,-1412,1504,16812\n107711,192295,-2000,1092,16304\n107581,192183,-1676,1580,16720\n107492,192164,328,1616,16272\n107403,192066,-168,1776,16416\n107357,192014,-360,1428,16276\n107262,191877,264,1344,16396\n107195,191804,780,1672,16556\n107081,191660,8120,1812,15544\n107045,191551,2340,1292,15684\n106981,191486,1088,1692,16472\n106989,191432,1188,1832,17212\n106982,191412,1320,1688,16604\n107036,191428,1240,1044,15520\n107097,191451,1248,1088,16324\n107148,191497,976,1404,16644\n107161,191471,1132,1408,16360\n107199,191477,1248,980,16116\n107167,191422,1604,916,16212\n107139,191388,1912,732,16192\n107043,191280,2448,788,16000\n106954,191250,3268,696,16072\n106855,191111,2804,532,16060\n106858,191139,2828,392,16552\n106770,191013,2204,-100,16932\n106761,191021,2396,264,16880\n106697,190963,2248,176,16352\n106687,190947,1928,352,16512\n106646,190941,1880,640,16344\n106657,190940,1660,224,16744\n106691,190968,1448,288,16012\n106691,190952,1548,228,15872\n106729,190989,560,52,16436\n106724,190998,800,176,16024\n106782,191055,988,212,16224\n106791,191044,1028,264,16500\n106844,191081,1024,-56,16180\n106835,191086,944,32,16016\n106899,191095,464,-796,15856\n106892,191074,424,-844,15652\n106890,191077,-52,-40,15816\n106869,191040,-252,-100,15932\n106870,191053,672,40,16080\n106892,191063,628,-148,16096\n106919,191113,1112,-232,16472\n106943,191092,1328,-520,16568\n106925,191050,1156,-184,16376\n106842,190959,708,-168,16392\n106809,190951,-428,-28,16372\n106723,190820,-1028,-452,16176\n106700,190878,-536,-152,16104\n106587,190785,-556,172,16664\n106608,190809,-652,-16,16772\n106566,190747,-560,-468,16736\n106591,190804,-92,-1036,16364\n106568,190788,268,-932,16568\n106597,190820,520,-1332,16352\n106579,190830,1068,-1500,16056\n106605,190818,1292,-688,15404\n106615,190844,848,68,15740\n106603,190824,820,-20,16660\n106664,190908,656,1436,18940\n106715,190982,272,1148,19076\n106883,191169,1484,88,17380\n106978,191288,1788,-896,15872\n107156,191425,1804,-1704,14716\n107222,191545,2584,-1720,15228\n107366,191557,4216,-116,15984\n107432,191630,5392,268,17056\n107490,191549,12324,-1552,15952\n107451,191591,2236,-56,13020\n107483,191616,3472,-2012,17336\n107477,191619,5236,24,18172\n107462,191640,5416,256,17840\n107441,191622,5936,-324,16924\n107495,191706,8080,-992,13828\n107521,191754,7752,-1148,13752\n107659,191901,5988,-1100,14176\n107665,191850,5536,-1216,13636\n107680,191856,7408,-48,11184\n107545,191671,8628,-1436,10612\n107457,191558,8460,-1184,11840\n107235,191272,8032,-360,14084\n107091,191158,8076,-140,16092\n106931,190999,7236,-480,17112\n106882,190979,6652,36,16848\n106833,190943,7908,292,15452\n106859,190952,7536,-112,14796\n106870,190962,6580,-680,15792\n106883,190980,6404,-708,15688\n106944,191049,6500,-732,15324\n107007,191101,5392,-1400,14968\n107191,191231,6816,-1148,14936\n107318,191342,7372,-880,15296\n107542,191528,6356,-992,16912\n107643,191603,6580,-1656,17380\n107726,191643,6896,-1100,15312\n107659,191573,7024,-1920,15048\n107604,191451,6984,-2084,14824\n107456,191358,6140,-1112,15148\n107370,191287,6392,-1792,14908\n107278,191176,6380,-2052,15412\n107216,191121,5616,-2844,16044\n107133,191026,6476,-2544,15712\n107066,190971,7396,-2372,15820\n106976,190859,7560,-2120,15940\n106887,190789,8104,-1548,16256\n106784,190668,7888,-1844,15012\n106744,190650,7772,-1760,14028\n106715,190568,7228,-2460,15328\n106782,190666,6944,-2760,16608\n106731,190603,8136,-3012,16888\n106777,190671,6932,-3064,17352\n106802,190666,7184,-3100,16900\n106853,190713,6768,-2464,17688\n106813,190731,6096,-1940,16756\n106863,190731,5592,-2296,15160\n106880,190780,4872,-2460,15376\n106921,190809,4964,-2052,16328\n106962,190886,5448,-3380,17776\n106995,190865,5232,-3084,19008\n107073,190952,4864,-3472,19172\n107081,190944,4228,-2740,18740\n107147,191015,4016,-1012,17484\n107139,191039,3056,-884,16132\n107224,191143,1492,-1580,14916\n107277,191200,920,-1732,14632\n107321,191232,1224,-1596,15976\n107343,191250,1124,-2112,15728\n107375,191275,520,-2700,14648\n107405,191308,472,-2780,14708\n107424,191341,-404,-2320,13876\n107454,191377,-780,-1580,12508\n107517,191452,-1312,-1144,12628\n107567,191480,-1320,-1124,13152\n107624,191547,-1832,-1792,14368\n107638,191525,-2324,-1816,15416\n107703,191627,-1536,-1808,16028\n107675,191584,-1212,-2188,16420\n107718,191681,-1544,-1852,15984\n107659,191634,-1760,-1208,14892\n107738,191752,-2172,-764,14224\n107721,191694,-2628,-652,14300\n107781,191790,-2892,-636,14912\n107748,191801,-1756,-2104,16600\n107739,191817,-1580,-2332,18956\n107725,191906,252,-2348,17124\n107777,191997,1116,-2220,15952\n107801,192029,2080,-1200,14964\n107750,191853,908,-600,15224\n107693,191705,320,-1236,15776\n107545,191427,1400,-1452,16412\n107409,191236,1328,-104,16148\n107249,191032,3684,-616,14080\n107186,190827,7528,-660,15100\n106939,190236,8380,24,14920\n106590,189110,8544,856,12580\n105815,187476,8484,1676,10652\n105214,186455,7344,2544,9320\n105081,186279,6204,3592,8276\n105340,186744,5988,3836,7352\n105738,187344,7340,3104,7376\n106074,187785,11200,1720,11048\n106116,187899,13916,660,14360\n106070,187953,14380,1288,16680\n105921,187826,14140,1528,15732\n105881,187799,12732,2020,14180\n105743,187602,10792,2000,12028\n105666,187407,9620,1712,11052\n105430,187018,9328,1836,10804\n105247,186735,9192,1592,11608\n104968,186438,8800,1076,13512\n104916,186442,8080,492,15780\n105121,186724,7636,-248,18588\n105532,187077,7160,-1000,18632\n105872,187383,7152,-1036,17732\n106046,187530,6024,-920,19228\n106161,187693,5136,-1496,19128\n106184,187684,4760,-1816,18568\n106232,187720,4468,-2960,19532\n106144,187628,3572,-3344,20924\n106065,187544,2712,-2556,20292\n105856,187428,3028,-2464,19612\n105697,187343,2376,-2620,18704\n105497,187271,1588,-3828,16380\n105399,187281,1284,-2976,14816\n105350,187294,988,-2608,13904\n105335,187306,-868,-4064,14372\n105339,187308,-1304,-4624,16496\n105371,187335,-900,-4388,18672\n105350,187300,272,-3800,18888\n105353,187334,724,-3412,17524\n105370,187293,284,-3196,16924\n105437,187391,40,-3376,16932\n105493,187408,-696,-3844,16956\n105606,187504,-872,-3840,17780\n105609,187458,464,-2096,17884\n105663,187531,472,-1412,17236\n105631,187453,444,-3176,17264\n105710,187491,-220,-3700,16260\n105733,187421,-268,-3304,14896\n105808,187427,-724,-2552,16104\n105864,187444,-1584,-1636,14632\n105980,187487,-2056,-324,13592\n106122,187583,-1996,-60,14092\n106187,187619,-1736,-596,14368\n106306,187745,-1276,-1228,15380\n106345,187754,-1684,-788,14456\n106448,187807,-2736,352,12624\n106454,187804,-2712,1844,12280\n106518,187869,-2372,2292,13020\n106505,187869,-1072,1768,13248\n106546,187906,-268,548,14084\n106486,187912,716,-1240,15152\n106461,187971,1160,-1872,15740\n106463,188011,372,-1820,14828\n106477,188099,-360,276,13412\n106456,188162,-800,980,12320\n106479,188302,-1104,916,12820\n106446,188425,-912,712,12900\n106466,188659,-948,944,13276\n106470,188796,-640,-664,13608\n106526,189036,16,-3888,15320\n106529,189150,432,-5884,16448\n106588,189371,672,-5596,16400\n106592,189438,1600,-4624,15568\n106677,189623,612,-4524,16224\n106681,189634,796,-3232,17476\n106775,189792,924,-3904,17996\n106786,189905,1072,-3620,19408\n106923,190133,1728,-4004,18404\n106975,190418,820,-3748,19016\n107073,190708,848,-3848,17744\n107166,190990,1076,-4316,16884\n107217,191211,1348,-4724,15664\n107312,191491,984,-5372,14676\n107342,191628,1144,-5920,13392\n107414,191779,1688,-6632,13188\n107447,191845,2100,-6976,13552\n107458,191902,2012,-6048,12704\n107418,191949,572,-4324,12604\n107465,192002,388,-3376,12456\n107440,191991,608,-3528,12764\n107439,191969,920,-3240,12224\n107406,191943,1844,-3532,13556\n107434,191958,1720,-3204,13200\n107443,191992,2028,-1744,11400\n107476,192012,3500,-5856,13148\n107452,191962,4284,-5984,12984\n107460,191971,6884,-8608,12488\n107395,191866,7048,-10200,13576\n107383,191913,6060,-8084,11052\n107337,191906,6628,-8356,9592\n107392,192059,6172,-8836,11728\n107340,192134,7784,-7580,10964\n107466,192347,9540,-10296,11804\n107476,192325,10952,-15844,16064\n107465,192361,11492,-16208,17788\n107374,192136,12524,-12884,15700\n107232,191720,12176,-12056,15896\n107038,191219,11980,-11272,16368\n106820,190761,12492,-11188,16328\n106706,190416,12308,-11512,16784\n106590,190107,12276,-11332,16640\n106601,190002,12740,-9988,16112\n106570,189876,13124,-10872,16904\n106577,189793,13172,-10488,17960\n106575,189705,13160,-9680,17528\n106574,189621,12148,-8448,16820\n106525,189511,10116,-5724,15028\n106506,189431,8508,272,15084\n106419,189187,8756,472,13092\n106280,188886,7484,-1188,13964\n106176,188738,7748,-3692,13984\n106179,188718,8920,-5084,14440\n106192,188846,9844,-4796,14156\n106307,189152,8356,-3876,13660\n106485,189612,6772,-1260,12112\n106786,190213,4984,2072,11564\n107059,190772,3324,2348,12404\n107372,191377,4120,-756,12192\n107460,191699,4444,-3324,13292\n107573,191637,4488,-6420,14280\n107286,191196,5196,-6112,14640\n107172,191021,5224,-4204,13952\n107085,190915,3652,-2196,12928\n107107,190945,2964,-380,11052\n107178,191042,1052,-1844,11300\n107263,191048,568,-4524,12060\n107243,190991,1428,-6140,12276\n107225,190837,2376,-6248,12288\n107200,190658,2760,-6216,12344\n107108,190336,2464,-6068,11500\n107090,190088,1340,-6104,10760\n107015,189871,848,-4832,11632\n107041,189820,2388,-2512,11024\n107007,189666,4156,-2852,12980\n106968,189572,7100,-2660,16468\n106944,189500,10584,880,22944\n106812,188967,6192,-2992,21332\n106064,187565,4408,-5548,16444\n105234,186814,3848,-3576,13500\n105098,186902,3280,-3388,13072\n105287,187287,600,-844,21276\n105129,186577,8260,-2240,15328\n104606,185537,6924,-2852,17992\n103938,184334,5140,-3704,16252\n103375,183610,5284,-4276,16776\n103203,183730,4980,-4748,16932\n103502,184460,5616,-4076,16720\n103880,185295,4988,-4248,16736\n104462,186328,5088,-5836,16784\n104985,187251,5212,-5460,16904\n105560,188151,5372,-4136,17564\n106020,188905,4820,-3484,17232\n106545,189715,4732,-3004,17040\n106989,190385,4872,-2888,16420\n107310,190846,4432,-2988,15656\n107545,191223,3692,-3160,15000\n107682,191465,3736,-3352,14648\n107847,191681,3016,-3724,14756\n107888,191798,2616,-3464,15032\n108002,191966,2184,-2476,14788\n108072,192129,1648,-1676,14288\n108196,192342,1636,-1884,14228\n108270,192501,1636,-2036,14632\n108304,192587,2424,-2280,15316\n108234,192623,2520,-1660,15104\n108206,192713,2220,-800,14840\n108202,192840,1180,32,14540\n108245,193034,1320,-568,14664\n108285,193231,980,-708,15404\n108392,193551,-516,-1500,15424\n108468,193816,-1068,-1752,15832\n108628,194203,-1340,-2592,16180\n108713,194430,-2404,-2228,16068\n108842,194779,-2444,-2408,15248\n108875,194839,-2824,-2476,14892\n108952,194940,-3172,-2824,14860\n108933,194801,-3284,-3292,15460\n108991,194817,-2980,-3360,16316\n108955,194657,-2672,-2532,16308\n109020,194602,-3028,-1836,15624\n109035,194462,-3356,-1016,14488\n109095,194368,-3680,-664,14132\n109152,194289,-4012,-920,14448\n109138,194156,-4028,-1372,14528\n109150,194136,-3536,-1892,14688\n109082,194059,-3136,-2644,14908\n109072,194007,-2780,-3168,15664\n108965,193898,-2748,-3028,15664\n108953,193794,-3020,-2812,15732\n108873,193632,-3396,-2340,15392\n108847,193508,-3776,-2060,14452\n108781,193412,-3728,-1572,13232\n108778,193338,-3292,-852,12592\n108754,193316,-1916,-716,12524\n108666,193297,984,-2860,13268\n108546,193285,3724,-5824,16300\n108480,193298,3932,-7148,18648\n108447,193254,2864,-7648,17240\n108510,193316,3076,-6896,16168\n108572,193317,3184,-6112,15184\n108684,193377,3184,-3960,14540\n108713,193327,4684,-2632,14128\n108750,193399,6516,-3892,15780\n108655,193264,7780,-7232,18496\n108664,193302,8404,-9576,19872\n108624,193228,8552,-11028,20616\n108665,193271,7664,-9660,20236\n108664,193215,6704,-6720,17968\n108676,193185,6120,-4732,16952\n108665,193141,5372,-3712,16408\n108664,193113,5136,-3976,16136\n108677,193161,6092,-5544,16452\n108648,193138,5816,-6820,17184\n108686,193268,5780,-6820,15944\n108682,193302,5500,-5760,15556\n108736,193370,5112,-3952,15620\n108703,193339,5088,-2740,14880\n108733,193382,4880,-2772,15676\n108758,193397,4116,-3736,16372\n108797,193415,3284,-4156,16584\n108792,193432,2752,-4180,16248\n108838,193505,2396,-4464,16668\n108851,193545,2320,-4572,17144\n108850,193590,2288,-5512,17632\n108848,193574,2224,-5336,17992\n108863,193548,1528,-4084,16240\n108846,193461,1232,-3372,15340\n108858,193408,1092,-3024,16200\n108852,193293,1208,-4592,17016\n108917,193313,1248,-5320,18524\n108994,193301,740,-3296,18404\n109234,193498,312,-1540,15988\n109419,193607,-2008,692,15320\n109606,193815,-3368,656,13820\n109612,193843,-3100,-84,12348\n109694,193974,-2840,-1416,11308\n109753,194131,-4464,-1888,13560\n109940,194297,-4984,-1136,13964\n109997,194380,-4036,-304,13912\n109964,194354,-3876,216,13584\n109868,194325,-4396,-24,13316\n109692,194178,-4960,524,12504\n109594,194064,-4668,1740,11240\n109399,193903,-4656,2284,10976\n109270,193792,-4748,2016,10480\n109117,193683,-5044,1480,10732\n109012,193608,-5056,1208,11076\n108776,193416,-3252,288,13404\n108655,193339,-3140,-72,13896\n108495,193267,-2844,-420,13364\n108410,193292,-2436,-936,13748\n108392,193327,-2304,-1012,14008\n108407,193479,-2060,-1280,13580\n108441,193638,-1424,-1664,13072\n108529,193881,-840,-3300,13440\n108556,194058,-968,-3960,14672\n108620,194390,956,-5264,15908\n108677,194732,2628,-6024,18860\n108828,195223,2400,-6056,19204\n108863,195488,3092,-5532,18144\n108980,195903,3384,-5248,18116\n109059,196176,3436,-5476,19388\n109169,196463,2900,-6608,20056\n109164,196536,2624,-7312,20112\n109135,196623,2932,-7480,19480\n109100,196558,2996,-5276,18396\n109127,196640,3896,-4000,17660\n109129,196661,4060,-4872,17900\n109098,196584,4008,-6780,18076\n109114,196589,4036,-5368,17216\n109097,196504,4164,-4200,16080\n109127,196482,4660,-3568,14812\n109132,196421,5168,-1480,15688\n109243,196438,6356,-2684,14452\n109226,196195,5888,-4188,15224\n109143,195982,5908,-3196,15320\n109034,195801,6492,-2884,14920\n108985,195673,5812,-3516,14312\n108942,195559,5212,-3876,13548\n108893,195515,4796,-4864,13172\n108865,195477,4424,-5524,13680\n108899,195563,5184,-5276,13940\n108882,195545,5216,-5868,14068\n108909,195608,4556,-6760,13820\n108836,195509,4332,-6588,13704\n108825,195492,4004,-6736,13560\n108729,195425,5116,-6728,13540\n108716,195470,5076,-6720,14188\n108624,195396,5388,-6220,14252\n108664,195539,4780,-5840,13880\n108653,195572,4392,-3928,13800\n108672,195641,4456,-3092,13660\n108566,195537,4020,-3296,13360\n108469,195426,3448,-3364,12760\n108344,195283,3652,-2948,12048\n108185,195041,3808,-3116,11688\n108047,194758,4332,-3404,11500\n107825,194265,5700,-5568,13308\n107662,193789,5756,-6776,17048\n107372,193162,6056,-6404,17824\n107106,192508,6076,-3992,17860\n106785,191847,5624,-4332,16412\n106455,191290,4876,-2936,15980\n106119,190778,3536,-1636,16452\n105630,190280,4760,-3044,16776\n105160,189970,7528,-6056,18428\n104758,188752,2020,-1796,16528\n103595,184149,2104,-68,12048\n81277,163840,4260,-6400,20224\n17487,65536,880,-4992,19828\n5776,3297,328,-3300,17348\n3369,1566,452,-3852,20396\n2463,1195,480,-2004,15084\n1803,1048,140,-2012,15168\n1454,1115,808,-2528,14488\n1169,1083,2136,-2512,15288\n989,1123,1948,-1148,16504\n821,1073,1064,-1756,16684\n772,1140,1400,-2812,16840\n736,1109,800,-1896,16584\n737,1138,428,-1464,16704\n685,1125,420,-1388,17256\n713,1132,584,-552,16492\n716,1157,1212,372,17140\n711,1108,420,-196,17548\n726,1146,-580,-1084,16428\n696,1104,-3196,-2576,12092\n729,1138,-2404,-3232,15524\n703,1108,-440,-352,15616\n733,1140,1112,-892,16788\n699,1115,2128,-312,16372\n700,1132,2200,-360,17276\n682,1116,2188,-220,17140\n714,1125,776,-220,16868\n689,1117,-440,-216,16948\n695,1137,-840,-52,16784\n683,1121,-560,-28,16916\n691,1127,-132,-136,16832\n673,1114,260,-1008,16876\n685,1132,452,-840,16072\n669,1117,624,-476,16288\n701,1148,1032,96,16632\n665,1106,1284,472,16688\n693,1178,1516,1256,16636\n641,1126,1344,1408,16696\n700,1192,1112,1432,16640\n657,1149,1008,996,16768\n688,1185,1076,840,17056\n665,1164,1008,1012,17256\n693,1186,1464,832,16672\n684,1184,1612,476,15868\n690,1174,1440,236,15816\n714,1202,1300,524,15980\n689,1169,1336,804,16388\n735,1206,1996,916,16288\n695,1169,2772,824,16092\n739,1182,2156,828,15988\n683,1163,884,536,15604\n738,1189,3588,1032,14504\n704,1175,5848,1644,12664\n728,1164,5444,-1248,14256\n696,1171,4988,668,15432\n714,1185,4632,852,15052\n701,1151,3192,640,15504\n695,1166,1624,1300,17332\n693,1153,-2636,3428,22544\n698,1184,-5708,2940,16804\n701,1148,-4716,1976,14388\n710,1189,-3816,1612,17360\n695,1149,1652,2060,17080\n699,1191,2932,784,15432\n681,1141,3916,740,14764\n716,1234,3416,512,14760\n678,1165,2284,928,15520\n725,1248,1052,1280,16532\n698,1195,-676,1896,17316\n718,1218,-1376,2024,16864\n691,1219,-480,1764,16524\n704,1215,852,1368,16044\n703,1214,1340,1288,15996\n729,1220,784,1268,16156\n743,1230,296,1452,16336\n731,1204,60,1500,16440\n754,1260,272,1452,16264\n726,1195,76,1548,16464\n774,1238,224,1516,16332\n726,1196,188,1512,16468\n733,1239,44,1456,16204\n725,1212,-60,1568,16332\n744,1210,132,1632,16308\n717,1203,212,1548,16264\n708,1195,72,1532,16200\n724,1199,88,1504,16220\n728,1210,-60,1352,16168\n718,1178,16,1396,16284\n735,1213,116,1488,16300\n737,1176,-436,1760,16072\n764,1210,-156,1432,16544\n745,1159,560,1300,16132\n776,1238,788,1252,16136\n738,1207,104,1404,16152\n781,1270,404,1180,16056\n728,1202,604,1328,16308\n744,1268,408,1720,16300\n738,1220,352,1452,16160\n739,1243,200,1100,16104\n717,1245,104,1520,16276\n735,1249,172,1644,16084\n745,1252,-284,1544,16300\n716,1208,132,1284,16240\n741,1267,200,1496,16212\n707,1199,212,1536,16444\n744,1239,-148,1336,16132\n724,1207,-780,1288,16304\n739,1247,844,1320,16564\n703,1215,828,1496,16020\n748,1225,100,1400,16172\n727,1223,-124,1512,16256\n737,1217,280,1356,16188\n722,1194,360,1492,16140\n712,1213,440,1424,16280\n719,1215,-20,1484,16188\n719,1224,-128,1468,16044\n709,1189,308,1480,16472\n710,1209,568,1336,16360\n704,1178,-128,1636,16148\n721,1205,1296,-932,19876\n688,1172,164,-64,18676\n710,1250,-224,1444,16432\n677,1199,660,1416,16628\n721,1282,32,1360,16340\n675,1199,364,1360,16620\n727,1268,292,1500,16644\n704,1235,588,1504,16640\n733,1255,436,1392,16396\n708,1259,428,1348,16556\n710,1265,260,1440,16244\n726,1250,672,1452,16236\n713,1225,1688,1964,15524\n746,1276,3440,2412,15964\n726,1230,-4952,1928,23884\n770,1251,-3296,1372,16992\n729,1237,-2096,1264,16612\n748,1246,32,1496,15372\n717,1231,-92,1436,16680\n722,1201,8,1464,15472\n703,1209,300,2168,16732\n756,1264,2036,1500,15576\n737,1245,2096,1812,16076\n710,1199,1264,1420,16432\n711,1198,8,1456,16452\n725,1213,-1088,1732,16388\n";
    size_t chunkSize = 32; // based on MTU size and performance
    size_t messageSize = 0;
    size_t bytesSent = 0;
    bool transferInProgress = false;
    bool sendEndMessage = false;

public:
    void onRead(NimBLECharacteristic* pCharacteristic) override {
        if (!transferInProgress && !sendEndMessage) {
            startMessageTransfer(message);
        }

        if (transferInProgress) {
            sendNextChunk(pCharacteristic);
        } else if (sendEndMessage) {
            sendEnd(pCharacteristic);
        }
    }

    void startMessageTransfer(const String& messageToSend) {
        uint8_t tempBuffer[messageToSend.length() + 1]; // Create a buffer for the bytes (including null terminator)
        messageToSend.getBytes(tempBuffer, messageToSend.length() + 1); // Extract the string as bytes
        messageSize = strlen((char*)tempBuffer); // Get the actual byte size

        bytesSent = 0;
        transferInProgress = true;

        Serial.println("Message transfer started");
    }

    void sendNextChunk(NimBLECharacteristic* pCharacteristic) {
        if (message.isEmpty()) {
            transferInProgress = false;
            Serial.println("Message is empty");
            return;
        }

        // Calculate the number of bytes left to send
        size_t bytesRemaining = messageSize - bytesSent;
        size_t bytesToSend = min(chunkSize, bytesRemaining);

        // Copy the next chunk of data into a buffer
        uint8_t buffer[chunkSize];
        message.substring(bytesSent, bytesSent + bytesToSend).getBytes(buffer, bytesToSend + 1); // +1 for null terminator

        // Send the chunk
        pCharacteristic->setValue(buffer, bytesToSend);
        pCharacteristic->notify();

        bytesSent += bytesToSend;
        Serial.printf("Sent %d/%d bytes\n", bytesSent, messageSize);

        if (bytesSent >= messageSize) {
            transferInProgress = false;
            sendEndMessage = true; // Set flag to send "END" message next
            Serial.println("Message transfer completed");
        }
    }

    void sendEnd(NimBLECharacteristic* pCharacteristic) {
        const char* endMessage = "END";
        pCharacteristic->setValue((uint8_t*)endMessage, strlen(endMessage));
        pCharacteristic->notify();

        Serial.println("Sent 'END' message");

        // Reset flags to start the process again
        sendEndMessage = false;
        transferInProgress = false;
    }
};

// Characteristic response for successful message transmission
class ConfirmationCallbacks : public NimBLECharacteristicCallbacks {
    void onWrite(NimBLECharacteristic* pCharacteristic) override {
        std::string confirmation = pCharacteristic->getValue();

        if (confirmation == "OK"){
            Serial.println("Confirmation received from app.");
        } else {
            Serial.println("Invalid confirmation received.");
        }
    }
};

// Characteristic response for successful time data transmission
class TimeSyncCallbacks : public NimBLECharacteristicCallbacks {
    void onWrite(NimBLECharacteristic* pCharacteristic) override {
        std::string value = pCharacteristic->getValue();

        // IMPORANT: send UNIX timestamp (seconds passed since 1970-01-01 00:00:00 UTC)
        // IMPORTANT2: send bytes in Little Endian
        if (value.length() == sizeof(unsigned long)) {
            syncedTime = *(unsigned long*)value.data(); //basically a casting to unsinged long from 4-byte string
            lastSyncMillis = millis();
            Serial.print("Synchronized time: ");
            Serial.println(syncedTime);
        } else {
            Serial.println("Invalid time data received");
        }
    }
};

unsigned long getCurrentTime() {
    if (syncedTime == 0) {
        // Not synchronized
        Serial.println("Time not synchronized");
        return 0;
    }

    unsigned long elapsedMillis = millis() - lastSyncMillis;
    unsigned long currentTime = syncedTime + elapsedMillis / 1000; // Adding elapsed timed to synced time
    return currentTime;
}


void setup() {
    Serial.begin(115200);
    Serial.println("Starting setup...");

    pinMode(LED_PIN_BLE, OUTPUT);
    digitalWrite(LED_PIN_BLE, HIGH);

    if (pAdvertising->isAdvertising() == false or pAdvertising == nullptr or pServer == nullptr or pService == nullptr) {
                    
        NimBLEDevice::init("ESP32_Smartband_mini");

        pServer = NimBLEDevice::createServer();
        pServer->setCallbacks(new ServerCallbacks());

        pService = pServer->createService(SERVICE_UUID);

        pMessageTransferCharacteristic = pService->createCharacteristic(
            MESSAGE_TRANSFER_UUID,
            NIMBLE_PROPERTY::READ | NIMBLE_PROPERTY::NOTIFY
            );
        pMessageTransferCharacteristic->setCallbacks(new MessageTransferCallbacks());

        confirmationCallbacks = new ConfirmationCallbacks();
        pConfirmationCharacteristic = pService->createCharacteristic(
            CONFIRMATION_UUID,
            NIMBLE_PROPERTY::WRITE
            );
        pConfirmationCharacteristic->setCallbacks(confirmationCallbacks);

        timeSyncCallbacks = new TimeSyncCallbacks();
        pTimeSyncCharacteristic = pService->createCharacteristic(
            TIME_SYNC_UUID,
            NIMBLE_PROPERTY::WRITE
            );
        pTimeSyncCharacteristic->setCallbacks(timeSyncCallbacks);

    pService->start();

    pAdvertising = NimBLEDevice::getAdvertising();
    pAdvertising->addServiceUUID(SERVICE_UUID);
    pAdvertising->start();
    }

    Serial.println("BLE mode activated and advertising started");

    time1 = millis();
}

void loop() {
    if(getCurrentTime() > 0 && millis() - time1 > 3000){
        Serial.print(getCurrentTime());
        time1 = millis();
    }
}